name: Collect Traffic Data

on:
  schedule:
    # Run every 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  collect-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Data branch
        uses: actions/checkout@v4
        with:
          ref: Data
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Debug - List directory contents
        run: |
          echo "Current directory:"
          pwd
          echo "Directory contents:"
          ls -la
          echo "Looking for requirements.txt:"
          find . -name "requirements.txt" || echo "Not found"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests sumolib
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          echo "Installed packages:"
          pip list | grep -i sumo
          python -c "import sumolib; print('sumolib OK')"

      - name: Collect traffic data
        run: python scripts/collect_traffic_data.py

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push data
        run: |
          git add data/trafficData/
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No new data to commit"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "ðŸ“Š Auto-collect traffic data: ${TIMESTAMP}"
            
            # Retry push with pull --rebase to handle concurrent conflicts
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin Data; then
                echo "Push successful!"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Push failed, pulling and retrying (attempt $RETRY_COUNT of $MAX_RETRIES)..."
                  git pull --rebase origin Data
                  sleep $((RETRY_COUNT * 2))
                else
                  echo "Push failed after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
